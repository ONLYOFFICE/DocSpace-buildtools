#!/bin/bash

set -e

. /usr/share/debconf/confmodule

case "$1" in
	configure)
		args=()

		# --- Base service ---
		db_get {{product}}/host || true
		APP_HOST="$RET"
		db_get {{product}}/port || true
		APP_PORT="$RET"
		db_get {{product}}/machinekey || true
		CORE_MACHINEKEY="$RET"

		[ -n "$APP_HOST" ] && args+=(-ash "$APP_HOST")
		[ -n "$APP_PORT" ] && args+=(-asp "$APP_PORT")
		[ -n "$CORE_MACHINEKEY" ] && args+=(-mk "$CORE_MACHINEKEY")

		# --- Database ---
		db_get {{product}}/db-host || true
		DB_HOST="$RET"
		db_get {{product}}/db-name || true
		DB_NAME="$RET"
		db_get {{product}}/db-user || true
		DB_USER="$RET"
		db_get {{product}}/db-pwd || true
		DB_PWD="$RET"
		db_get {{product}}/db-port || true
		DB_PORT="$RET"

		if [ -n "$DB_HOST" ] && [ -n "$DB_NAME" ] && [ -n "$DB_USER" ] && [ -n "$DB_PORT" ]; then
			args+=(-mysqlh "$DB_HOST" -mysqld "$DB_NAME" -mysqlu "$DB_USER" -mysqlport "$DB_PORT")
			[ -n "$DB_PWD" ] && args+=(-mysqlp "$DB_PWD")
		elif [ -n "$DB_HOST$DB_NAME$DB_USER$DB_PWD$DB_PORT" ]; then
			echo "Warning: not all database parameters are set, skipping DB config"
		fi

		# --- Redis ---
		db_get {{product}}/redis-host || true
		REDIS_HOST="$RET"
		db_get {{product}}/redis-port || true
		REDIS_PORT="$RET"
		db_get {{product}}/redis-username || true
		REDIS_USER="$RET"
		db_get {{product}}/redis-password || true
		REDIS_PWD="$RET"
		db_get {{product}}/redis-db || true
		REDIS_DB="$RET"

		if [ -n "$REDIS_HOST" ] && [ -n "$REDIS_PORT" ]; then
			args+=(-rdh "$REDIS_HOST" -rdp "$REDIS_PORT")
			[ -n "$REDIS_USER" ] && args+=(-rdu "$REDIS_USER")
			[ -n "$REDIS_PWD" ] && args+=(-rdpw "$REDIS_PWD")
			[ -n "$REDIS_DB" ] && args+=(-rdb "$REDIS_DB")
		elif [ -n "$REDIS_HOST$REDIS_PORT$REDIS_USER$REDIS_PWD$REDIS_DB" ]; then
			echo "Warning: not all Redis parameters are set, skipping Redis config"
		fi

		# --- RabbitMQ ---
		db_get {{product}}/rabbitmq-protocol || true
		RABBITMQ_SCHEME="$RET"
		db_get {{product}}/rabbitmq-host || true
		RABBITMQ_HOST="$RET"
		db_get {{product}}/rabbitmq-port || true
		RABBITMQ_PORT="$RET"
		db_get {{product}}/rabbitmq-user || true
		RABBITMQ_USER="$RET"
		db_get {{product}}/rabbitmq-password || true
		RABBITMQ_PASSWORD="$RET"

		if [ -n "$RABBITMQ_HOST" ] && [ -n "$RABBITMQ_PORT" ] && [ -n "$RABBITMQ_USER" ]; then
			args+=(-rbh "$RABBITMQ_HOST" -rbp "$RABBITMQ_PORT" -rbu "$RABBITMQ_USER")
			[ -n "$RABBITMQ_SCHEME" ] && args+=(-rbpr "$RABBITMQ_SCHEME")
			[ -n "$RABBITMQ_PASSWORD" ] && args+=(-rbpw "$RABBITMQ_PASSWORD")
		elif [ -n "$RABBITMQ_HOST$RABBITMQ_PORT$RABBITMQ_USER$RABBITMQ_PASSWORD$RABBITMQ_SCHEME" ]; then
			echo "Warning: not all RabbitMQ parameters are set, skipping RabbitMQ config"
		fi

		# --- OpenSearch ---
		db_get {{product}}/elasticsearch-scheme || true
		ELK_SCHEME="$RET"
		db_get {{product}}/elasticsearch-host || true
		ELK_HOST="$RET"
		db_get {{product}}/elasticsearch-port || true
		ELK_PORT="$RET"

		if [ -n "$ELK_HOST" ] && [ -n "$ELK_PORT" ]; then
			args+=(-ess "$ELK_SCHEME" -esh "$ELK_HOST" -esp "$ELK_PORT")
		elif [ -n "$ELK_HOST$ELK_PORT$ELK_SCHEME" ]; then
			echo "Warning: not all OpenSearch parameters are set, skipping OpenSearch config"
		fi

		# --- External Docs ---
		db_get {{product}}/ds-url || true
		DOCUMENT_SERVER_URL_EXTERNAL="$RET"
		db_get {{product}}/jwt-secret || true
		DOCUMENT_SERVER_JWT_SECRET="$RET"
		db_get {{product}}/jwt-header || true
		DOCUMENT_SERVER_JWT_HEADER="$RET"

		if [ -n "$DOCUMENT_SERVER_URL_EXTERNAL" ]; then
			if [ -n "$DOCUMENT_SERVER_JWT_SECRET" ] && [ -n "$DOCUMENT_SERVER_JWT_HEADER" ]; then
				args+=(-docsurl "$DOCUMENT_SERVER_URL_EXTERNAL" -js "$DOCUMENT_SERVER_JWT_SECRET" -jh "$DOCUMENT_SERVER_JWT_HEADER")
			else
				echo "Warning: Docs URL is set, but JWT secret/header are missing â€” skipping Docs config"
			fi
		fi

		# --- Run configuration ---
		bash /usr/bin/{{product}}-configuration "${args[@]}"

		exit 0
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;

	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
