[SERVICE]
    Flush               1
    Log_Level           info
    Daemon              off

[INPUT]
    Name                forward
    Listen              127.0.0.1
    Port                24224

[OUTPUT]
    Name                opensearch
    Match               *
    Host                OPENSEARCH_HOST
    Port                OPENSEARCH_PORT
    Replace_Dots        On
    Suppress_Type_Name  On
    Time_Key            @timestamp  
    Type                _doc
    Index               onlyoffice-fluent-bit

[FILTER]
    Name                lua
    Match               *
    call                delete_old_index_records
    code                function delete_old_index_records(tag, timestamp, record) os.execute(string.format("curl -s -X POST '%s://%s:%s/%s/_delete_by_query' -H 'Content-Type: application/json' -d '{\"query\": {\"range\": {\"@timestamp\": {\"lt\": \"%s\"}}}}'", "OPENSEARCH_SCHEME", "OPENSEARCH_HOST", "OPENSEARCH_PORT", "onlyoffice-fluent-bit", os.date("!%Y-%m-%dT%H:%M:%S", os.time() - 2592000))) end
