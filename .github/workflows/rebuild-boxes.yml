name: Rebuild DocSpace vagrant boxes

run-name: "Rebuild DocSpace vagrant boxes version: ${{ github.event.inputs.box-version }} (OS: ${{ github.event.inputs.os-name }})"

on:
  workflow_dispatch:
    inputs:
      box-version:
         type: string
         description: 'DocSpace version that will be installed inside box'
         required: true
      os-name:
        type: string
        description: 'Select distros'
        required: true
        default: |
          rhel9,
          centos9s,
          centos10,
          debian11,
          debian12,
          debian13,
          ubuntu2204,
          ubuntu2404

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
    steps:
      - name: Ensure jq
        run: |
          command -v jq >/dev/null 2>&1 || { sudo apt-get update -y && sudo apt-get install -y jq; }

      - name: Build matrix from input
        id: mk
        shell: bash
        run: |
          set -euo pipefail
          OS_INPUT="${{ github.event.inputs.os-name }}"

          MAP=$(cat <<'JSON'
          {
            "rhel9":     {"distr":"generic","os":"rhel9"},
            "centos9s":  {"distr":"onlyoffice","os":"base-centos9s"},
            "centos10":  {"distr":"onlyoffice","os":"base-centos10"},
            "debian11":  {"distr":"onlyoffice","os":"base-debian11"},
            "debian12":  {"distr":"onlyoffice","os":"base-debian12"},
            "debian13":  {"distr":"onlyoffice","os":"base-debian13"},
            "ubuntu2204":{"distr":"onlyoffice","os":"base-ubuntu2204"},
            "ubuntu2404":{"distr":"onlyoffice","os":"base-ubuntu2404"}
          }
          JSON
          )

          MATRIX="$(jq -cn --arg input "$OS_INPUT" --argjson map "$MAP" '
            def norm: gsub("[\n\r]+"; ",") | gsub("\\s+"; "");
            ($input | norm) as $inp
            | ( if $inp == "all"
                then ($map | keys)
                else ($inp | split(",") | map(select(length>0)) | unique)
              end ) as $keys
            | [ $keys[] as $k
                | select($map | has($k))
                | ({name:$k} + $map[$k])
              ]
            | {include: .}
          ')"

          test "$(jq '.include|length' <<<"$MATRIX")" -gt 0 || { echo "No valid OS selected."; exit 1; }
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  vagrant-up:
    name: "Rebuild DocSpace ${{ matrix.name }}"
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    env:
      HCP_CLIENT_ID: ${{ secrets.HCP_CLIENT_ID }}
      HCP_CLIENT_SECRET: ${{ secrets.HCP_CLIENT_SECRET }}
      BOX_VERSION: ${{ github.event.inputs.box-version }}
      VAGRANT_ORG: onlyoffice
      PRODUCT: docspace
      OS_NAME: ${{ matrix.name }}
      OS: ${{ matrix.os }}
      DISTR: ${{ matrix.distr }}
    steps:
      - name: Free Disk Space
        run: |
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/refs/heads/${{ github.ref_name }}/.github/scripts/free-disk-space-linux.sh | sudo VBOX_SAFE=1 bash

      - name: Checkout code
        uses: actions/checkout@v4

      - name: 'Download hcp CLI'
        uses: 'hashicorp/hcp-setup-action@v0'
        with:
          version: 'latest'

      - name: Get update and install vagrant
        run: |
          set -eux
          gpg --keyserver keyserver.ubuntu.com --recv-keys A2F683C52980AECF && gpg --export A2F683C52980AECF > /usr/share/keyrings/virtualbox.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/virtualbox.gpg] https://download.virtualbox.org/virtualbox/debian $(. /etc/os-release && echo $UBUNTU_CODENAME) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list
          sudo wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          sudo echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update -y
          sudo apt install vagrant -y
          # Temporary install VBox 7.1.12 via curl (.deb) to avoid SSH/NAT issues in 7.1.14
          curl -fsSL "https://download.virtualbox.org/virtualbox/7.1.12/virtualbox-7.1_7.1.12-169651~Ubuntu~jammy_amd64.deb" -o /tmp/vbox.deb && sudo apt-get install -y /tmp/vbox.deb

      - name: Rebuild boxes
        uses: nick-fields/retry@v3
        with:
          max_attempts: 2
          timeout_minutes: 90
          retry_on: error
          command: |
                  set -eux   
                  cd tests/vagrant
                    TEST_CASE='--local-install' \
                    DISTR='${{ matrix.distr }}' \
                    OS='${{matrix.os}}' \
                    RAM='8192' \
                    CPU='3' \
                    DOWNLOAD_SCRIPT='-ds false' \
                    TEST_REPO='-tr true' \
                    ARGUMENTS="-arg '--skiphardwarecheck true --localscripts true'" \
                    vagrant up --provider=virtualbox
                  sleep 300
                  vagrant package --output ${PRODUCT}-${OS_NAME}.box
                  wget https://raw.githubusercontent.com/ONLYOFFICE/ga-common/refs/heads/master/.github/scripts/vagrant_publish.sh
                  bash ./vagrant_publish.sh
          on_retry_command: |
                set -eux

                echo "RUN CLEAN UP: Remove repacked box and destroy"
                cd tests/vagrant
                rm -rf ${PRODUCT}-${OS_NAME}.box
                vagrant destroy --force

